# v0.2a Plan

Status: Partially implemented.
Spec: docs/specs/v0.2a.md

## Implemented (evidence)
- Input history, session-only behavior, max size, draft restore: `src/tui/history.rs`, `src/tui/app.rs`
- Command palette UI + fuzzy filtering + navigation + popup placement: `src/tui/widgets/command_palette.rs`, `src/tui/app.rs`, `src/tui/ui.rs`
- SQL context parser + schema-aware completions + FK join suggestions + completion UI: `src/tui/sql_autocomplete.rs`, `src/tui/widgets/sql_completion.rs`, `src/tui/app.rs`
- Clipboard backends and text selection copy: `src/tui/clipboard.rs`, `src/tui/app.rs`, `src/tui/widgets/chat.rs`
- Vim mode toggle + normal/insert handling + mode indicator + vim scroll keys: `src/commands/handlers/system.rs`, `src/tui/app.rs`, `src/tui/widgets/input.rs`
- Sticky scroll indicator and relative timestamps in query log: `src/tui/app.rs`, `src/tui/widgets/chat.rs`, `src/tui/widgets/sidebar.rs`
- Row numbers toggle and empty-result message: `src/tui/widgets/table.rs`, `src/commands/handlers/system.rs`, `src/tui/app.rs`

## Missing or incomplete vs spec (with implementation notes)
- Command palette activation: should open when "/" typed at start of non-empty input; current logic only opens when input is empty. Update input handlers in `src/tui/app.rs`.
- Command palette behavior: Ctrl+C should close palette and clear input; current Ctrl+C exits or copies selection. Intercept in `src/tui/app.rs` or `src/tui/mod.rs`.
- Command palette default list: spec implies palette shows commands on "/" with empty filter; current state hides all commands until 1+ char. Adjust `CommandPaletteState::update_filtered` in `src/tui/widgets/command_palette.rs`.
- Input history: Down arrow at newest should clear input (spec), but current behavior is a no-op when history position is None. Update `InputHistory::next` or `src/tui/app.rs` key handling.
- SQL autocomplete activation: should only appear after 1+ characters unless Ctrl+Space; current `update` shows suggestions with empty filter. Gate visibility in `src/tui/widgets/sql_completion.rs` or call-site.
- SQL autocomplete contexts: table name suggestions after `UPDATE` and `INSERT INTO` are missing. Add contexts in `src/tui/sql_autocomplete.rs` and completions in `src/tui/widgets/sql_completion.rs`.
- SQL autocomplete recency ranking: `record_completion` is never called on acceptance. Wire it in `App::accept_sql_completion` in `src/tui/app.rs`.
- Quick actions: `y`/`e`/`r` use `App.last_executed_sql`, but it is never set on query completion. Populate it when adding a `QueryLogEntry` or in `handle_orchestrator_response` in `src/tui/mod.rs`.
- Copy last SQL in vim mode depends on the above and currently always shows "No SQL to copy".
- Visual feedback: query spinner is global; spec requires inline spinner after SQL and thinking indicator replaced by streaming response. Add per-message placeholders in `src/tui/app.rs` and render in `src/tui/widgets/chat.rs`.
- Result highlight flash on new results is missing. Add a short-lived highlight state in `src/tui/app.rs` and render in `src/tui/widgets/chat.rs` or `src/tui/widgets/table.rs`.
- Connection status indicator: header dot exists but never flips to disconnected; no status text/tooltip. Wire connection state changes and display in `src/tui/app.rs`, `src/tui/mod.rs`, `src/tui/widgets/header.rs`.
- Sticky scroll: clicking the "New messages" banner should jump to bottom; `banner_area` is stored but unused. Handle it in `App::handle_mouse_event` in `src/tui/app.rs`.
- Query log navigation: click entry should jump to corresponding chat results; current selection only opens a modal. Add log-to-chat mapping and scroll logic in `src/tui/app.rs` and `src/tui/widgets/sidebar.rs`.
- Query log separators: spec groups by natural language question; current separators are time-gap based. Add grouping metadata when queries are generated and use it in `src/tui/widgets/sidebar.rs`.
- Cancel operation: spec requires double-Esc within 500ms; async loop cancels on single Esc and `cancel_requested` is unused. Implement double-Esc handling and cancellation wiring in `src/tui/app.rs` and `src/tui/mod.rs`.
- Resize debounce: spec calls for 50ms debounce; current event handling renders on every resize event. Add debounce in `src/tui/events.rs` or `src/tui/mod.rs`.
- Long query bell: config fields exist but no bell trigger. Call `App::request_bell` when execution time exceeds threshold and honor config in `src/tui/mod.rs` or `src/app.rs`.
- Config integration: `vim_mode`, `row_numbers`, `bell_*`, and panel width ratios are not applied or persisted. Load defaults into `App` on startup and persist toggles in `src/config.rs`, `src/tui/mod.rs`, `src/tui/ui.rs`.

## Suggested sequencing
- Phase 1: Wire last_executed_sql, fix command palette activation/Ctrl+C, SQL completion recency.
- Phase 2: SQL completion context gaps, history Down-arrow behavior, sticky scroll click.
- Phase 3: Visual feedback (inline spinners, result highlight), query log navigation/grouping.
- Phase 4: Double-Esc cancel, resize debounce, long-query bell, config wiring.

## Implementation Plan (thorough)
### Phase 1 - Input and quick actions
1) Update command palette activation and Ctrl+C behavior in `src/tui/app.rs` and `src/tui/widgets/command_palette.rs`.
2) Ensure `App.last_executed_sql` is set when a query completes; update quick action handlers to use it.
3) Wire SQL completion recency by calling `record_completion` on acceptance.

### Phase 2 - SQL completion contexts + history behavior
1) Extend SQL context parsing to include UpdateTable and InsertTable with table-name suggestions.
2) Gate SQL completions to only show after 1+ typed characters unless forced by Ctrl+Space.
3) Adjust history Down-arrow logic to clear input at newest entry.

### Phase 3 - Navigation + sticky scroll
1) Use `banner_area` to detect click and jump to bottom; clear `has_new_messages`.
2) Add query log to chat mapping and scroll-to-result behavior; update sidebar click handling.

### Phase 4 - Visual feedback
1) Add per-message placeholders for LLM thinking and DB execution; replace on streaming/results.
2) Add result highlight flash state with 200ms timeout.
3) Ensure connection status is updated and displayed with status text.

### Phase 5 - Resize, bell, and config
1) Debounce resize events to 50ms.
2) Trigger bell on long queries, honor config, and allow disabling.
3) Apply config defaults for vim mode, row numbers, and panel width ratios; persist toggles for /vim and /rownumbers.

### Phase 6 - Validation
- Add headless or manual test scripts for palette behavior, SQL completion contexts, quick actions, sticky scroll click, and bell triggering.
- Verify query log grouping and navigation across multiple LLM questions.
