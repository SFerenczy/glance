# v0.2a Specification

> Terminal Polish

**Status**: Planned  
**Target**: Enhanced terminal UX and productivity features

---

## Overview

v0.2a focuses on terminal polish and productivity enhancements. This release improves the day-to-day experience with input history, command autocomplete, vim-style navigation, visual feedback during operations, and clipboard support.

---

## User Stories

### US-1: Recall Previous Input

> As a user, I want to recall my previous inputs so I can quickly re-run or modify past queries.

**Acceptance Criteria:**

- Arrow Up cycles through previous inputs (most recent first)
- Arrow Down cycles forward through input history
- History persists for the session (not across restarts)
- Editing a recalled input does not modify the history entry
- Empty inputs are not added to history

### US-2: Autocomplete Commands

> As a user, I want autocomplete for slash commands so I can discover and use them faster.

**Acceptance Criteria:**

- Typing `/` in empty input shows command palette
- Fuzzy matching filters commands as user types
- Arrow keys navigate suggestions
- Tab accepts selected suggestion and closes palette
- Esc dismisses autocomplete

### US-3: SQL Autocomplete

> As a user, I want intelligent SQL autocomplete when writing raw queries.

**Acceptance Criteria:**

- `/sql` mode provides schema-aware completions
- Table names autocomplete after FROM, JOIN, UPDATE, INSERT INTO
- Column names autocomplete after SELECT, WHERE, ORDER BY, based on context
- Fuzzy matching ranks suggestions by relevance
- Join suggestions based on foreign key relationships
- Alias tracking (e.g., `u.` completes columns from `users u`)

### US-4: Copy to Clipboard

> As a user, I want to copy text from the terminal to my clipboard.

**Acceptance Criteria:**

- Mouse drag selects text in chat panel and result tables
- Ctrl+C copies selected text to clipboard
- `y` key copies last executed SQL to clipboard (vim mode)
- Visual feedback confirms copy action
- Selection clears after copy or on click elsewhere

### US-5: Vim-Style Navigation (Opt-in)

> As a user familiar with vim, I want to optionally enable vim-style navigation.

**Acceptance Criteria:**

- `/vim` command toggles vim mode on/off
- Vim mode is **disabled by default**
- When enabled: `j`/`k` scroll chat, `g`/`G` jump to top/bottom
- When enabled: Normal/Insert mode switching with `Esc`/`i`
- When disabled: Standard input behavior (no mode switching)
- Mode indicator only shown when vim mode is enabled

### US-6: Visual Operation Feedback

> As a user, I want visual feedback when operations are in progress.

**Acceptance Criteria:**

- Typing indicator ("...") shows while LLM is generating
- Spinner animation shows during database query execution
- New results briefly highlight when they appear
- Timestamps show relative time ("2m ago") on query log entries

### US-7: Quick Actions

> As a user, I want keyboard shortcuts for common actions.

**Acceptance Criteria:**

- `r` re-runs the last query
- `e` loads last query into input bar for editing
- `?` shows quick help overlay
- Any key dismisses help overlay

---

## Functional Requirements

### FR-1: Input History

#### FR-1.1: History Navigation

- Up Arrow: Navigate to previous input (older)
- Down Arrow: Navigate to next input (newer)
- When at newest entry, Down Arrow clears input
- Maximum 100 entries stored in memory

#### FR-1.2: History Behavior

- History is session-only (cleared on exit)
- Duplicate consecutive entries are not added
- Empty inputs are not added
- Submitting a recalled input adds it as new entry at end

#### FR-1.3: Edit Preservation

When navigating history:

- Current unsaved input is preserved as temporary entry
- Returning to newest position restores unsaved input
- Modifications to recalled entries do not alter history

---

### FR-2: Command Autocomplete

#### FR-2.1: Activation

- Typing `/` in empty input immediately shows command palette
- Typing `/` with existing input shows palette if cursor is at start
- Palette appears as floating overlay above input

#### FR-2.2: Command Palette UI

```
┌─────────────────────────────┐
│ /sql     Execute raw SQL    │
│ /schema  Show schema        │
│ /clear   Clear chat         │
│ /help    Show help          │
│ /quit    Exit application   │
└─────────────────────────────┘
```

#### FR-2.3: Fuzzy Matching

- Match against command name and description
- Score based on: prefix match > substring match > fuzzy match
- Update results as user types
- Minimum 1 character after `/` to filter

#### FR-2.4: Palette Navigation

| Key    | Action                         |
| ------ | ------------------------------ |
| ↑/↓    | Navigate suggestions           |
| Tab    | Accept selected, close palette |
| Esc    | Close palette, keep input      |
| Ctrl+C | Close palette, clear input     |

---

### FR-3: SQL Autocomplete

#### FR-3.1: Activation

- Active when input starts with `/sql `
- Triggered by typing or explicit Ctrl+Space
- Appears after typing 1+ characters of identifier

#### FR-3.2: Context-Aware Completions

| Context                     | Suggestions                  |
| --------------------------- | ---------------------------- |
| After SELECT                | Column names, `*`, functions |
| After FROM / JOIN           | Table names                  |
| After WHERE / AND / OR      | Column names, operators      |
| After ORDER BY              | Column names, ASC/DESC       |
| After INSERT INTO           | Table names                  |
| After UPDATE                | Table names                  |
| After table alias (e.g. u.) | Columns from aliased table   |

#### FR-3.3: Join Suggestions

When completing JOIN:

- Suggest tables with foreign key relationships to current tables
- Include ON clause template based on FK relationship
- Example: `JOIN orders o ON o.user_id = u.id`

#### FR-3.4: Alias Tracking

- Parse query to identify table aliases
- Track alias → table mapping
- Complete `alias.` with columns from referenced table
- Support multiple aliases in same query

#### FR-3.5: Ranking

Suggestions ranked by:

1. Exact prefix match
2. Case-insensitive prefix match
3. Substring match
4. Fuzzy match
5. Recency of use (within session)

#### FR-3.6: Completion UI

```
┌────────────────────────────┐
│ users          table       │
│ user_id        column      │
│ user_name      column      │
│ user_roles     table       │
└────────────────────────────┘
```

- Show type indicator (table, column, keyword, function)
- Maximum 8 suggestions visible
- Scroll if more available

---

### FR-4: Clipboard Support

#### FR-4.1: Copy Last SQL

- `y` key (when not in input mode) copies last executed SQL
- Visual confirmation: "Copied to clipboard" toast (2s)
- Uses system clipboard

#### FR-4.2: Text Selection

- Mouse drag selects text in chat panel
- Selection highlighted with inverted colors
- Ctrl+C copies selection (when not in input mode)
- Click elsewhere clears selection

#### FR-4.3: Platform Integration

- Linux: Use `xclip` or `xsel` if available, fallback to OSC 52
- macOS: Use `pbcopy`
- Windows: Use native clipboard API
- Graceful fallback if clipboard unavailable

---

### FR-5: Navigation Enhancements

#### FR-5.1: Vim-Style Keys

| Key    | Action                 | Mode   |
| ------ | ---------------------- | ------ |
| j      | Scroll down one line   | Normal |
| k      | Scroll up one line     | Normal |
| g      | Jump to top of chat    | Normal |
| G      | Jump to bottom of chat | Normal |
| Ctrl+d | Scroll down half page  | Normal |
| Ctrl+u | Scroll up half page    | Normal |

"Normal" mode = input bar not focused.

#### FR-5.2: Vim Mode Toggle

- `/vim` command toggles vim mode on/off
- Default: **disabled** (standard input behavior)
- When enabled:
  - Show mode in status area: `-- INSERT --` or `-- NORMAL --`
  - Esc switches from insert to normal mode
  - `i` or typing switches to insert mode
- When disabled:
  - No mode indicator shown
  - All keys go directly to input
  - Esc clears input or closes overlays

#### FR-5.3: Sticky Scroll

- Auto-scroll to bottom when new content arrives
- If user has scrolled up, disable auto-scroll
- Show "↓ New messages" indicator when not at bottom
- Clicking indicator or pressing G returns to bottom and re-enables auto-scroll

#### FR-5.4: Query Log Navigation

- Click on query log entry jumps to that query's results in chat
- Selected query highlighted in log
- Chat scrolls to show the query and its results

---

### FR-6: Visual Feedback

#### FR-6.1: LLM Thinking Indicator

- Show animated `...` or `Thinking...` while awaiting LLM response
- Animation: cycling dots (. → .. → ... → .)
- Appears in chat panel where response will appear
- Replaced by actual response when streaming begins

#### FR-6.2: Query Execution Spinner

- Show spinner while database query executes
- Animation: `⠋ ⠙ ⠹ ⠸ ⠼ ⠴ ⠦ ⠧ ⠇ ⠏` (braille spinner)
- Appears inline after SQL in chat
- Replaced by results or error when complete

#### FR-6.3: Result Highlight

- New results flash briefly (200ms) with accent background
- Fade to normal styling
- Draws attention to new content

#### FR-6.4: Relative Timestamps

- Query log entries show relative time: "just now", "2m ago", "1h ago"
- Update every minute
- Full timestamp on hover/focus (if terminal supports)

#### FR-6.5: Connection Status

- Small indicator in header: `●` green = connected, `○` gray = disconnected
- Tooltip/status text: "Connected to mydb@localhost"
- Indicator updates on connection state change

---

### FR-7: Input Enhancements

#### FR-7.1: Clear Input

- Ctrl+U clears entire input line
- Standard readline behavior

#### FR-7.2: Cancel Operation

- Double-tap Esc (within 500ms) clears input AND cancels pending operation
- Single Esc: switch to normal mode / close overlay
- Pending operation = awaiting LLM response or query execution

#### FR-7.3: Multi-line Paste

When paste detected with newlines:

- If single SQL statement: convert newlines to spaces
- If multiple statements: prompt user "Paste as single query? [y/n]"
- Preserve paste in input for user review before submit

---

### FR-8: Quick Actions

#### FR-8.1: Re-run Last Query

- `r` key (normal mode) re-executes last SQL query
- Same safety rules apply (confirm mutations)
- Query added to log as new entry

#### FR-8.2: Edit Last Query

- `e` key (normal mode) loads last SQL into input bar
- Prefixed with `/sql ` for raw execution
- Cursor placed at end of input
- Switches to insert mode

#### FR-8.3: Help Overlay

- `?` key (normal mode) shows quick reference overlay
- Overlay covers center of screen
- Lists all keyboard shortcuts grouped by category
- Any key dismisses overlay

```
┌─────────────────────────────────────────────┐
│              Quick Reference                │
├─────────────────────────────────────────────┤
│ Navigation                                  │
│   j/k        Scroll up/down                 │
│   g/G        Top/bottom of chat             │
│   Tab        Switch panel focus             │
│                                             │
│ Actions                                     │
│   r          Re-run last query              │
│   e          Edit last query                │
│   y          Copy last SQL                  │
│                                             │
│ Input                                       │
│   ↑/↓        Input history                  │
│   Ctrl+U     Clear input                    │
│   Esc Esc    Cancel operation               │
│                                             │
│           Press any key to close            │
└─────────────────────────────────────────────┘
```

---

### FR-9: Query Log Enhancements

#### FR-9.1: Visual Separators

- Add separator line between query groups
- Group = queries from same natural language question
- Separator: thin horizontal line or timestamp header

#### FR-9.2: Manual Query Visibility

- Raw SQL queries (via `/sql`) appear in query log
- Same format as LLM-generated queries
- Indicator showing "manual" vs "generated"

#### FR-9.3: Panel Width on Focus

- When query log focused, expand to 50% width
- When chat focused, query log returns to 30% width
- Smooth transition animation (100ms ease-out)

---

### FR-10: Quality of Life

#### FR-10.1: Graceful Resize

- UI reflows smoothly on terminal resize
- No artifacts or corruption
- Maintain scroll position relative to content
- Debounce resize events (50ms)

#### FR-10.2: Empty State

When query returns 0 rows:

```
No results found.
Query executed successfully in 12ms.
```

#### FR-10.3: Row Numbers

- Optional row numbers in result tables
- Toggle with `/rownumbers` command
- Persisted in config

```
┌───┬────┬────────────────┬────────────┐
│ # │ id │ email          │ name       │
├───┼────┼────────────────┼────────────┤
│ 1 │ 1  │ alice@test.com │ Alice      │
│ 2 │ 2  │ bob@test.com   │ Bob        │
└───┴────┴────────────────┴────────────┘
```

#### FR-10.4: Long Query Notification

- If query takes >5 seconds, emit terminal bell on completion
- Configurable threshold in config
- Can be disabled: `[ui] bell_on_completion = false`

---

## Keyboard Reference

### Normal Mode (Vim Mode Enabled Only)

| Key    | Action                   |
| ------ | ------------------------ |
| j      | Scroll down one line     |
| k      | Scroll up one line       |
| g      | Jump to top              |
| G      | Jump to bottom           |
| Ctrl+d | Scroll down half page    |
| Ctrl+u | Scroll up half page      |
| r      | Re-run last query        |
| e      | Edit last query          |
| y      | Copy last SQL            |
| ?      | Show help overlay        |
| i      | Enter insert mode        |
| /      | Enter insert mode with / |
| Tab    | Switch panel focus       |
| Enter  | Select query log entry   |

### Insert Mode / Standard Mode

| Key     | Action                                             |
| ------- | -------------------------------------------------- |
| Enter   | Submit input                                       |
| ↑       | Previous history entry                             |
| ↓       | Next history entry                                 |
| Ctrl+U  | Clear input                                        |
| Esc     | Exit to normal mode (vim) / Clear input (standard) |
| Esc Esc | Cancel pending operation                           |
| Tab     | Accept autocomplete                                |

### Global

| Key    | Action           |
| ------ | ---------------- |
| Ctrl+C | Exit application |
| Ctrl+Q | Exit application |
| Ctrl+L | Clear chat       |

---

## Configuration

### New Config Options

```toml
[ui]
# Enable vim-style navigation (can also toggle with /vim command)
vim_mode = false

# Show row numbers in result tables
row_numbers = false

# Terminal bell on long query completion
bell_on_completion = true
bell_threshold_seconds = 5

# Panel width ratios
chat_panel_width = 0.7
query_log_width_focused = 0.5
```

---

## Non-Functional Requirements

### NFR-1: Performance

- Autocomplete suggestions appear within 50ms of keystroke
- History navigation is instantaneous (<16ms)
- Animations run at 60fps (16ms frame time)
- Clipboard operations complete within 100ms

### NFR-2: Responsiveness

- All keyboard shortcuts respond within one frame
- No input lag during autocomplete
- Smooth scrolling without jank

### NFR-3: Accessibility

- All features accessible via keyboard
- No reliance on color alone for status indication
- Screen reader compatible where terminal supports

---

## Out of Scope for v0.2a

- Persistent history across sessions
- Custom keybinding configuration
- Mouse-based text editing
- Result cell expansion/preview
- Query bookmarks/favorites
- Undo/redo for input

---

## Future Features (Post v0.2a)

- `Y` key to copy last result data as tab-separated values (TSV)
- Result cell selection and copy
- Copy result as JSON/CSV format options

---

## Dependencies

- v0.1 must be complete
- Clipboard crate for cross-platform clipboard access
- No new LLM or database dependencies

---

## Open Questions

1. **Vim mode default**: Should vim-style navigation be opt-in or opt-out?
   - _Decision_: Opt-in via `/vim` command, disabled by default

2. **Autocomplete trigger**: Should SQL autocomplete require explicit trigger (Ctrl+Space) or be automatic?
   - _Proposed_: Automatic with debounce, Ctrl+Space forces immediate

3. **History persistence**: Should we add optional history persistence in v0.2a or defer?
   - _Decision_: Defer to v0.3

---

## Glossary

| Term            | Definition                                                 |
| --------------- | ---------------------------------------------------------- |
| Command Palette | Overlay showing available slash commands with fuzzy search |
| Normal Mode     | Navigation mode where keys control scrolling, not input    |
| Insert Mode     | Text entry mode where keys go to input bar                 |
| Sticky Scroll   | Auto-scroll behavior that pauses when user scrolls up      |
| Toast           | Temporary notification message that auto-dismisses         |
