# v0.2b Specification

> Persistence & Connections

**Status**: Planned  
**Target**: Local persistence for connections, query history, saved queries, and runtime LLM configuration with safe redaction to the AI

---

## Overview

v0.2b adds first-class persistence and connection management. Users can save database profiles, switch connections mid-session with a clean slate, keep query history across runs, curate saved queries with tags, and configure LLM providers/keys inside the TUI. All persisted data lives in a local SQLite file; AI context stays free of secrets (no passwords or hostnames).

---

## User Stories

### US-1: Manage Saved Connections

> As a user, I want to save and reuse database connections without retyping credentials.

**Acceptance Criteria**
- Can create, edit, delete named connections
- Passwords stored on disk only after explicit confirmation; encrypted when OS keyring is available
- Listing connections never shows passwords; host/user redacted in any AI-facing context

### US-2: Switch Connections Mid-Session

> As a user, I want to switch to another saved connection and get a fresh session.

**Acceptance Criteria**
- `/connect <name>` switches to that profile
- Switching cancels in-flight work, re-introspects schema, and clears chat/LLM context, query log, and input history
- Header updates to new connection display string (no password/host leakage)

### US-3: Persist Query History

> As a user, I want my past queries to be available after restarting the app.

**Acceptance Criteria**
- All executed queries (manual or LLM-generated) are stored in SQLite with connection name, status, timing, and timestamps
- `/history` shows persisted history with filters (connection, time window, text search)
- History caps (time/count) avoid unbounded growth and can be cleared

### US-4: Save Queries with Tags

> As a user, I want to save useful queries, add tags, and recall them quickly.

**Acceptance Criteria**
- Can save current input or last executed SQL with a name, optional description, and tags
- Can list, search, and insert a saved query into the input bar
- Tags are free-form, allow multiple per query, and are scoped per connection (plus global option)

### US-5: LLM Reads Saved Queries (Metadata Only)

> As a user, I want the LLM to see my saved queries and tags to reuse them, but not see secrets.

**Acceptance Criteria**
- LLM tool can list/search saved queries + tags (read-only)
- Tool response never includes passwords, hostnames, or result data
- Connection is identified only by a display label/database name

### US-6: Configure LLM Provider/Keys in TUI

> As a user, I want to set or change my LLM provider, model, and API key without leaving the app.

**Acceptance Criteria**
- `/llm provider <openai|anthropic|ollama>` switches provider
- `/llm key` prompts for key, persists it, and never echoes full key (only last 4 shown)
- `/llm model <name>` updates the model for the current provider
- Keys are persisted to disk (encrypted when possible) and applied immediately

---

## Functional Requirements

### FR-1: Local Persistence Store

- Use SQLite file at `~/.config/db-glance/state.db` (Linux/macOS) or `%APPDATA%\\db-glance\\state.db` (Windows); create parent dirs if missing.
- Enable WAL mode; single-writer expected. Handle lock contention with retry/backoff.
- Maintain schema version table; on mismatch, migrate forward or fail with clear guidance.

### FR-2: Connection Profiles

- **Commands**
  - `/connections` list saved connections (name, database, last used, redacted host/user)
  - `/connect <name>` switch to saved profile
  - `/conn add <name>` guided prompt for host, port, database, user, password, sslmode, extras
  - `/conn edit <name>` update fields
  - `/conn delete <name>` remove profile (confirmation required)
- **Storage**
  - Persist profiles in SQLite `connections` table; preserve created/updated timestamps and last_used_at.
  - Password handling: default to encrypt-at-rest using OS keyring or platform secure storage; if unavailable, require explicit confirmation to store plaintext and warn on every read.
  - Passwords never rendered in UI; host/user only shown in connection list (not sent to LLM).
- **Validation**
  - Validate required fields (database) and connection string formatting before save.
  - Test connection option during add/edit; show friendly error on failure.

### FR-3: Connection Switching

- Switching cancels in-flight LLM/DB tasks, clears any pending confirmations, and resets:
  - Chat messages, LLM conversation history, query log, input history, and sticky scroll state.
- After switch, re-introspect schema for the new connection; cached schema is per-connection and not reused across names.
- Update header connection indicator; show toast "Connected to <name>" or error on failure.
- On failure, remain on prior connection; never leave app in no-connection limbo unless no prior existed.

### FR-4: Query History Persistence

- Record for every executed query (manual or LLM):
  - id, connection_name, submitted_by (`user` | `llm`), sql, status (`success` | `error` | `cancelled`), execution_time_ms, row_count (nullable), error_message (nullable), created_at.
- `/history [--conn <name>] [--text <filter>] [--since <duration>] [--limit N]` shows persisted entries in a scrollable list; Enter loads SQL into input (not auto-run).
- Retention: keep max 5,000 entries or 90 days (whichever smaller); oldest pruned on insert. `/history clear` wipes history after confirmation.
- History entries link to saved queries when applicable (saved_query_id nullable foreign key).

### FR-5: Saved Queries & Tags

- **Commands**
  - `/savequery <name> [#tags...]` saves current input (or last executed SQL if input empty); prompts for description if not provided.
  - `/queries [--conn <name>|--all] [--tag <tag>] [--text <filter>]` lists/searches saved queries.
  - `/usequery <name>` loads saved query into input (prefixed with `/sql `) without executing.
  - `/query delete <name>` removes a saved query (confirmation required).
- **Behavior**
  - Tags are free-form strings, multiple per query; default scope = connection-specific; prefix `#global:` makes it global.
  - Fields stored: name (unique per connection scope), sql, description, tags, connection_name (nullable for global), created_at, updated_at, last_used_at, usage_count.
  - Editing a saved query updates timestamps and usage metrics; show toast on save/update/delete.

### FR-6: LLM Tooling (Read-Only)

- Provide a tool to the LLM to list/search saved queries:
  - Input: optional `connection_name`, `tags[]`, `text`, `limit`.
  - Output per entry: name, sql, description, tags, connection_label/database name, last_used_at, usage_count.
- Tool is read-only; LLM cannot create/update/delete saved queries.
- Strip/omit host, user, passwords, and any result data from tool output.

### FR-7: Dynamic LLM Provider & API Key Setup

- **Commands**
  - `/llm provider <openai|anthropic|ollama>` sets provider; persists to `state.db`.
  - `/llm key` prompts for secret input; masks on-screen; stores encrypted when possible; only last 4 chars shown after save.
  - `/llm model <name>` sets model for current provider; persists.
- Apply changes immediately to new LLM requests; existing conversation history is cleared on provider change.
- Keys stored alongside provider/model in `state.db` (not in plaintext config unless encryption unavailable and user opts in with warning).

### FR-8: Privacy & Redaction

- LLM prompts may include: database name, user-provided connection label, schema. They must not include: passwords, hostnames, usernames.
- Query history exports to LLM (if ever) must redact host/user and never include result rows.
- On-screen displays that show connection info must omit passwords and indicate redaction (e.g., `mydb @ ******:5432` when needed).

### FR-9: Error Handling & Recovery

- If `state.db` is missing or corrupt, recreate it after backing up the old file (`state.db.bak`), and surface a toast with path and action taken.
- If secure storage for passwords/keys is unavailable, show a persistent warning badge in the header until dismissed.
- All commands return clear, single-line errors suitable for the chat panel.

---

## Non-Functional Requirements

- Persistence operations (save/list) complete within 50ms for typical sizes (<5k rows).
- Switching connections, including schema introspection, completes within 3s on a healthy network; show spinner during work.
- Stored secrets encrypted when platform facilities exist; plaintext requires explicit user consent.
- Data file size kept under 50MB via retention/pruning; operations degrade gracefully if limits reached.

---

## Out of Scope for v0.2b

- Multiple simultaneous active connections
- Sync/sharing of saved queries or history across machines
- Team/role-based access to saved content
- Encrypting query results (results are not stored)

---

## Glossary

| Term              | Definition                                                      |
| ----------------- | ---------------------------------------------------------------- |
| Connection Label  | User-friendly name for a saved connection (no secrets)          |
| Global Tag        | Tag prefixed with `global:` that applies across connections      |
| History Entry     | Persisted record of an executed query (metadata only)            |
| Saved Query       | User-curated SQL with name/description/tags stored for reuse     |
| State DB          | Local SQLite file (`state.db`) holding connections and metadata  |
