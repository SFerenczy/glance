# v0.2b Plan

Status: In progress (Phase 1 complete, Phase 2 complete, Phase 3 partial).
Spec: docs/specs/v0.2b.md

## Implemented (evidence)
- Local SQLite state DB path, WAL mode, migrations: src/persistence/mod.rs, src/persistence/migrations.rs
- Connections CRUD persistence and /connections, /conn add/edit/delete: src/persistence/connections.rs, src/commands/handlers/connection.rs
- Query history persistence and /history list/clear: src/persistence/history.rs, src/commands/handlers/history.rs
- Saved queries persistence and /savequery, /queries, /usequery, /query delete: src/persistence/saved_queries.rs, src/commands/handlers/queries.rs
- LLM settings persistence and /llm provider/model/key: src/persistence/llm_settings.rs, src/commands/handlers/llm_settings.rs
- LLM tool list_saved_queries: src/llm/tools.rs, src/llm/service.rs

## Completed in this session (2026-01-25)
### Phase 1 - Connection switching (COMPLETE)
- ✅ Connection switch cancellation/flush: src/tui/mod.rs:556-557 (cancel_all_pending before switch)
- ✅ App reset helper: src/tui/app.rs:645-680 (reset_for_connection_switch method)
- ✅ Input history reset: Included in reset_for_connection_switch
- ✅ Headless mode support: src/tui/headless/mod.rs:346-347

### Phase 2 - Connection CRUD improvements (COMPLETE)
- ✅ Extras plumbing: src/commands/router.rs (ConnectionAddArgs, ConnectionEditArgs updated with extras field)
- ✅ Extras parsing: src/commands/router.rs:314-348 (unknown key-value pairs collected as extras)
- ✅ Extras storage: src/commands/handlers/connection.rs:210,304 (stored in profile)
- ✅ --test for /conn edit: src/commands/router.rs:94, src/commands/handlers/connection.rs:271-290
- ✅ Redacted display: src/commands/handlers/connection.rs:31-43 (shows ******@******:port)
- ✅ Redacted header: src/tui/app.rs:419 (uses display_string_redacted)

### Phase 3 - History UX (PARTIAL)
- ✅ Duration parsing: src/commands/router.rs:9-33 (parse_duration_to_days supports 7d, 12h, 15m)
- ✅ --since accepts durations: src/commands/router.rs:511 (uses parse_duration_to_days)
- ✅ /history clear confirmation: src/commands/handlers/history.rs:61-77, src/commands/router.rs:109 (requires --confirm flag)
- ⏸️ History selection-to-load: NOT STARTED (requires TUI changes)

### Phase 4 - Saved Queries Improvements (COMPLETE)
- ✅ Current input wiring: src/commands/handlers/mod.rs:32 (current_input field in CommandContext, TUI layer needs to populate)
- ✅ Description argument: src/commands/router.rs:115, src/commands/router.rs:533 (description= argument supported)
- ✅ Update on name collision: src/commands/handlers/queries.rs:49 (checks existing query and updates)
- ✅ /query delete confirmation: src/commands/router.rs:140, src/commands/router.rs:597, src/commands/handlers/queries.rs:155 (requires --confirm)
- ✅ Global tag behavior: src/commands/handlers/queries.rs:37 (normalizes tags, handles #global:)
- ✅ Saved query ID history linkage: src/app.rs:109, src/app.rs:856 (pending_saved_query_id field and usage)
- ✅ Default connection at startup: src/app.rs:164 (creates __default__ connection for history tracking)
- ✅ InputHistory clear method: src/tui/history.rs:110 (clears all entries)

## Missing or incomplete vs spec (with implementation notes)
- Gap: /conn add/edit are inline-only, extras are ignored, edit lacks --test, and connection string validation is minimal. Implement guided prompts and extras plumbing in src/commands/router.rs, src/commands/handlers/connection.rs, and src/persistence/connections.rs; add edit-time --test support and validation before save.
- Gap: /connections list does not show redacted username, and header display for config connections leaks host. Implement redacted user display and use display_string_redacted for header in src/commands/handlers/connection.rs, src/tui/app.rs, and src/config.rs.
- Gap: /connect does not cancel in-flight work or reset UI state (chat, query log, input history, scroll, pending confirmations). Implement cancellation/queue flush in src/tui/mod.rs and add an App reset helper in src/tui/app.rs invoked on InputResult::ConnectionSwitch (also update src/tui/headless/mod.rs).
- Gap: input history is not cleared on connection switch. Reset InputHistory in src/tui/app.rs when handling connection switches.
- Gap: /history clear ignores confirmation, /history has no selection-to-load behavior, and --since only accepts raw days. Implement confirmation in src/commands/handlers/history.rs; add selectable history entries that load SQL into input in src/tui/app.rs and src/tui/mod.rs; parse duration strings in src/commands/router.rs and support them in src/persistence/history.rs.
- Gap: history entries never set saved_query_id and are skipped for unsaved default connections. Plumb saved_query_id from /usequery in src/commands/handlers/queries.rs through src/app.rs into src/query/executor.rs; create a default connection row at startup in src/app.rs and set current_connection_name so history always records a connection.
- Gap: /savequery ignores current input, does not prompt for description, cannot update existing saved queries, and /query delete lacks confirmation; no toast feedback. Implement current_input wiring in CommandContext and its call sites (src/app.rs, src/tui/mod.rs), add a description prompt or description= arg in src/commands/router.rs and src/commands/handlers/queries.rs, use update_saved_query when name exists, add confirmation for delete, and use App::show_toast in src/tui/app.rs.
- Gap: global tag behavior (#global:) is not applied. Implement tag normalization and global scope handling in src/persistence/saved_queries.rs and in /savequery handling.
- Gap: LLM tool tag filtering only uses the first tag. Implement multi-tag filtering in src/llm/service.rs and src/persistence/saved_queries.rs (decide AND vs OR semantics).
- Gap: /llm key does not prompt or mask input. Implement a masked input prompt in the TUI and route the value to handle_llm_key in src/commands/handlers/llm_settings.rs and src/tui/app.rs.
- Gap: lock contention retry is defined but unused. Wrap history logging and LLM settings updates with with_retry in src/persistence/mod.rs, src/persistence/history.rs, and src/persistence/llm_settings.rs.
- Gap: schema version mismatch (db newer than code) does not fail with guidance. Add a check in src/persistence/migrations.rs and surface the error in src/app.rs.
- Gap: DB recovery does not notify the user, and secure-storage warning badge is missing. Emit a toast on recovery and add a dismissible header badge based on SecretStorageStatus in src/tui/app.rs and src/tui/mod.rs.
- Gap: LLM prompt does not include redacted connection label/database (optional in spec), but if included it must exclude host/user/password. Use ConnectionContext in src/llm/service.rs with redaction from src/llm/prompt.rs.

## Suggested sequencing
- Phase 1: Connection switch cancellation/reset, history confirmation/loading, input history reset.
- Phase 2: Saved queries improvements (current input, description, global tags, update/delete confirmation, saved_query_id plumbing).
- Phase 3: LLM settings prompt, multi-tag filtering, persistence retry, schema mismatch handling, UI warning badge.

## Implementation Plan (thorough)
### Phase 0 - Prep and guardrails
- Read `docs/specs/v0.2b.md` and confirm expected UX behavior, error cases, and any spec-defined text (messages/labels).
- Inventory current behavior by scanning relevant modules: `src/app.rs`, `src/tui/mod.rs`, `src/tui/app.rs`, `src/commands/router.rs`, `src/commands/handlers/*.rs`, `src/persistence/*.rs`, `src/llm/*.rs`.
- Define the minimum test surface to touch (unit tests if present under `tests/`, otherwise add targeted tests or manual verification steps in plan).
- Agree on multi-tag filtering semantics (AND vs OR) before code changes; document the choice in plan/PR notes.

### Phase 1 - Connection switching: cancellation + state reset
1) Cancel/flush in-flight work when switching connections
   - Add or expose a cancellation/flush mechanism in `src/tui/mod.rs` for pending query execution, LLM calls, or background tasks triggered by UI actions.
   - Ensure that the cancel path propagates to any running tasks and clears pending confirmations/queues.
2) Centralized App reset helper
   - Add `App::reset_for_connection_switch()` in `src/tui/app.rs` to clear:
     - chat buffer, query log/output, input history, scroll positions, pending confirmations, transient UI state.
   - Call it on `InputResult::ConnectionSwitch` in `src/tui/mod.rs` and `src/tui/headless/mod.rs`.
3) Input history reset
   - Ensure input history is wiped in the reset helper; confirm no other path retains history after a switch.
4) Manual verification
   - Start a long-running query, switch connection, confirm it cancels and UI resets.
   - Verify no stale confirmations or pending actions remain.

### Phase 2 - Connection CRUD UX gaps
1) Guided prompts + extras plumbing for `/conn add` and `/conn edit`
   - In `src/commands/router.rs`, detect missing args and prompt for fields (name, type, host, port, db, user, password).
   - Plumb `extras` through `src/commands/handlers/connection.rs` into `src/persistence/connections.rs` so it is stored and loaded.
2) Inline-only edit fixes and `--test`
   - Add `--test` handling to `edit` path to verify the updated connection before save.
   - Validate connection strings before save (minimum parsing/format checks).
3) Redacted display for `/connections list` and header
   - Ensure username is redacted in list output; use `display_string_redacted` for header labels.
   - Update `src/commands/handlers/connection.rs`, `src/tui/app.rs`, and `src/config.rs` to avoid leaking host.
4) Manual verification
   - Add/edit connection via prompts; ensure extras persist.
   - Verify header and list outputs redact username/host correctly.

### Phase 3 - History UX and behavior
1) Confirmation for `/history clear`
   - Add confirmation prompt in `src/commands/handlers/history.rs`, with a cancel path that does not clear.
2) Selection-to-load behavior
   - Make history entries selectable and load SQL into input on selection in `src/tui/app.rs` and `src/tui/mod.rs`.
3) `--since` duration parsing
   - Parse duration strings (e.g., `30d`, `12h`, `15m`) in `src/commands/router.rs`.
   - Use parsed duration in `src/persistence/history.rs` for queries.
4) Manual verification
   - Confirm history clear prompts and can be canceled.
   - Select history entry and confirm input is populated.
   - Use `--since 7d` and `--since 12h`.

### Phase 4 - Saved queries improvements and history linkage
1) Current input wiring
   - Extend `CommandContext` to include current input text.
   - Populate it from `src/app.rs` and `src/tui/mod.rs`.
2) Description prompt or argument
   - In `src/commands/router.rs`, accept `description=` arg or prompt when missing.
   - Update `src/commands/handlers/queries.rs` to save description.
3) Update on name collision
   - When a saved query exists with the same name, update it via `update_saved_query` instead of erroring.
4) `/query delete` confirmation + toast
   - Add confirmation flow before deletion.
   - Use `App::show_toast` for success/failure for `/savequery`, `/query delete`, `/usequery`.
5) Global tag behavior
   - Normalize tags and implement `#global:` semantics in `src/persistence/saved_queries.rs`.
   - Ensure `/savequery` handling respects global scope.
6) History linkage for saved queries
   - Plumb `saved_query_id` from `/usequery` in `src/commands/handlers/queries.rs` through `src/app.rs` into `src/query/executor.rs`.
   - Ensure history rows set `saved_query_id`.
7) Default connection row at startup
   - On app startup in `src/app.rs`, ensure a default connection exists and `current_connection_name` is set.
8) Manual verification
   - Save a query from current input, update it by reusing the same name.
   - Delete with confirmation and see toast.
   - Use query and confirm history has `saved_query_id`.

### Phase 5 - LLM and filtering improvements
1) LLM key masked input
   - Add a masked input prompt in TUI for `/llm key` and pass the value to `handle_llm_key`.
   - Update `src/commands/handlers/llm_settings.rs` and `src/tui/app.rs`.
2) Multi-tag filtering in LLM tools
   - Implement multi-tag filter in `src/llm/service.rs` and `src/persistence/saved_queries.rs`.
   - Apply chosen AND/OR semantics consistently.
3) LLM prompt redacted connection context
   - Use `ConnectionContext` in `src/llm/service.rs` to include only redacted label/database.
   - Ensure host/user/password are excluded per `src/llm/prompt.rs`.
4) Manual verification
   - Set LLM key via prompt and verify persistence.
   - Query LLM tool with multiple tags.
   - Confirm prompt content redacts connection details.

### Phase 6 - Persistence robustness and schema mismatch
1) Use `with_retry` for lock contention
   - Wrap history logging and LLM settings updates with `with_retry` in `src/persistence/history.rs` and `src/persistence/llm_settings.rs`.
   - Ensure `src/persistence/mod.rs` exposes the helper as needed.
2) Schema version mismatch error
   - Add guard in `src/persistence/migrations.rs` to detect newer DB version than code.
   - Surface a clear error in `src/app.rs` with guidance to upgrade.
3) DB recovery and secret storage badge
   - Emit a toast on recovery events.
   - Add a dismissible header badge in `src/tui/app.rs`/`src/tui/mod.rs` based on `SecretStorageStatus`.
4) Manual verification
   - Simulate newer schema version and confirm error guidance.
   - Trigger recovery path and check toast/badge behavior.

### Phase 7 - Final validation
- Run any existing tests that cover persistence, commands, and TUI state; add targeted tests if gaps are obvious.
- Perform manual smoke test for all updated commands:
  - `/conn add`, `/conn edit`, `/connections`, `/connect`, `/history`, `/savequery`, `/queries`, `/usequery`, `/query delete`, `/llm provider/model/key`.
- Update `v0.2b-plan.md` with completion notes and evidence links once each phase lands.
